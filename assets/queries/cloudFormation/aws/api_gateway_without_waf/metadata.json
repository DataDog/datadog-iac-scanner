{
  "id": "fcbf9019-566c-4832-a65c-af00d8137d2b",
  "queryName": "API Gateway without WAF",
  "severity": "MEDIUM",
  "category": "Networking and Firewall",
  "descriptionText": "API Gateway stages must be protected by a web application firewall (WAF) to block common application-layer attacks such as SQL injection and cross-site scripting, and to reduce the risk of malicious or abusive traffic causing data exposure or service disruption.\n\n Verify that each `AWS::ApiGateway::Stage` resource (its `StageName`) has a corresponding `AWS::WAFv2::WebACLAssociation` resource. The association must set `Properties.ResourceArn` to the API Gateway stage ARN (format: `arn:aws:apigateway:{region}::/restapis/{restapi-id}/stages/{stageName}`) and must reference a valid WAF via `Properties.WebACLArn`. Resources missing the `AWS::WAFv2::WebACLAssociation`, or whose `ResourceArn` does not reference the stage's `StageName`, will be flagged.\n\nSecure CloudFormation example:\n\n```yaml\nMyWebACL:\n  Type: AWS::WAFv2::WebACL\n  Properties:\n    Name: my-webacl\n    Scope: REGIONAL\n    DefaultAction:\n      Allow: {}\n\nMyApi:\n  Type: AWS::ApiGateway::RestApi\n  Properties:\n    Name: my-api\n\nMyStage:\n  Type: AWS::ApiGateway::Stage\n  Properties:\n    StageName: prod\n    RestApiId: !Ref MyApi\n\nMyWebACLAssociation:\n  Type: AWS::WAFv2::WebACLAssociation\n  Properties:\n    ResourceArn: !Sub \"arn:aws:apigateway:${AWS::Region}::/restapis/${MyApi}/stages/prod\"\n    WebACLArn: !Ref MyWebACL\n```",
  "descriptionUrl": "https://docs.datadoghq.com/security/code_security/iac_security/iac_rules/cloudFormation/aws/api_gateway_without_waf",
  "platform": "CloudFormation",
  "descriptionID": "774d759c",
  "cloudProvider": "aws",
  "cwe": "778",
  "providerUrl": "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-wafv2-webaclassociation.html#cfn-wafv2-webaclassociation-resourcearn"
}
