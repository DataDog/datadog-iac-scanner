{
  "id": "4ba74f01-aba5-4be2-83bc-be79ff1a3b92",
  "queryName": "Serverless function without unique IAM role",
  "severity": "HIGH",
  "category": "Insecure Configurations",
  "descriptionText": "Sharing an IAM execution role across multiple AWS Serverless functions increases blast radius and can give unrelated functions identical privileges, making privilege escalation or lateral movement easier if one function is compromised. For `AWS::Serverless::Function` resources, the `Properties.Role` value must be unique for each function and should reference a function-specific IAM role ARN. This rule flags `Resources.<name>.Properties.Role` when the same `Role` value is assigned to more than one `AWS::Serverless::Function`. Fix this by defining a distinct `AWS::IAM::Role` per function (or omitting `Role` to let AWS SAM create unique roles) and applying least-privilege policies to each role.\n\nSecure configuration with distinct roles:\n\n```yaml\nMyFunctionRole1:\n  Type: AWS::IAM::Role\n  Properties:\n    AssumeRolePolicyDocument:\n      Version: \"2012-10-17\"\n      Statement:\n        - Effect: Allow\n          Principal:\n            Service: lambda.amazonaws.com\n          Action: sts:AssumeRole\n    Policies:\n      - PolicyName: MyFunction1Policy\n        PolicyDocument:\n          Version: \"2012-10-17\"\n          Statement:\n            - Effect: Allow\n              Action:\n                - logs:CreateLogGroup\n                - logs:CreateLogStream\n                - logs:PutLogEvents\n              Resource: \"*\"\n\nMyFunction1:\n  Type: AWS::Serverless::Function\n  Properties:\n    Role: !GetAtt MyFunctionRole1.Arn\n    Handler: index.handler\n    Runtime: nodejs14.x\n\nMyFunctionRole2:\n  Type: AWS::IAM::Role\n  Properties:\n    AssumeRolePolicyDocument:\n      Version: \"2012-10-17\"\n      Statement:\n        - Effect: Allow\n          Principal:\n            Service: lambda.amazonaws.com\n          Action: sts:AssumeRole\n    Policies:\n      - PolicyName: MyFunction2Policy\n        PolicyDocument:\n          Version: \"2012-10-17\"\n          Statement:\n            - Effect: Allow\n              Action:\n                - dynamodb:GetItem\n              Resource: arn:aws:dynamodb:us-east-1:123456789012:table/MyTable\n\nMyFunction2:\n  Type: AWS::Serverless::Function\n  Properties:\n    Role: !GetAtt MyFunctionRole2.Arn\n    Handler: index.handler\n    Runtime: nodejs14.x\n```",
  "descriptionUrl": "https://docs.datadoghq.com/security/code_security/iac_security/iac_rules/cloudformation/aws_sam/serverless_function_without_unique_iam_role",
  "platform": "CloudFormation",
  "descriptionID": "50e760ce",
  "cloudProvider": "aws",
  "cwe": "269",
  "oldSeverity": "MEDIUM",
  "providerUrl": "https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-function.html#sam-function-role"
}