name: KICS Test Gate

# This workflow blocks PRs from being merged to main if tests in critical KICS packagesfail.
# TODO: Expand gate to include all critical KICS packages once their tests are fixed
# TODO: Expand gate to run ALL tests within KICS packages once their tests are fixed
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:  # Allow manual trigger from Actions tab

permissions:
  contents: read        # Read access to checkout code
  pull-requests: write  # Write access to post PR comments

jobs:
  kics-tests:
    name: Critical KICS Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Get dependencies
        run: go mod download

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest

      - name: Run critical KICS tests
        id: engine-tests
        # TODO: ./pkg/scanner is not included, takes too long to run in Github. Add it back when we have a faster way to run it in CI.
        run: |
          echo "üîç Running critical KICS tests..."
          gotestsum --format testname -- -v -short -timeout 15m ./pkg/engine ./pkg/analyzer ./pkg/parser ./pkg/parser/terraform/... ./pkg/parser/yaml ./pkg/engine/source ./pkg/scan ./pkg/builder/... ./pkg/kics ./test/e2e ./pkg/utils ./test/... ./pkg/report/model
          echo "‚úÖ All critical KICS tests passed!"

      - name: Comment on PR (on failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Critical Tests Failed**\n\nOne or more critical test suites failed. These packages are critical to KICS security scanning functionality.\n\n**This PR cannot be merged until these tests pass.**\n\nPlease review the test failures and fix the issues.\n\n[View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
            })

      - name: Set status
        if: failure()
        run: |
          echo "::error::Critical KICS tests failed - blocking merge"
          exit 1
